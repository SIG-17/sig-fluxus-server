<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SIG WS test page</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css"
          integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        html, body {
            height: 100%; /* Ensure html and body take full viewport height */
            margin: 0;
            padding: 0;
        }

        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            gap: 1em;
        }

        div.title-v {
            display: flex;
            flex-direction: column;
            gap: .3em;
        }

        .pure-menu-item .title-v {
            gap: .3em;
            margin-left: 1em;
        }

        .pure-menu-item .title-v .title {
            margin: 0;
            padding: .7em .5em 0 0;
        }

        .pure-menu-item .title-v .subtitle {
            margin: 0;
            padding: .1em .5em .1em .1em;
        }

        div.title-h {
            display: flex;
            flex-direction: row;
            gap: .5em;
            align-items: center;
        }

        .pure-menu-item .title-h {
            gap: 0;
        }

        .pure-menu-item .title-h .title, .pure-menu-item .title-h .subtitle {
            margin: 0;
            padding: .5em;
        }

        .flex-menu.pure-menu-horizontal .pure-menu-list {
            display: flex;
            align-items: end;
            width: 100%;
        }

        h1.title {
            text-align: center;
            margin-bottom: 0;
            color: rgba(0, 0, 0, 0.73);
        }

        h2.title, h3.title {
            text-align: left;
            margin: .6em 1em 0;
        }

        h4.subtitle, h5.subtitle {
            text-align: left;
            margin: .3em 2em 0;
            color: rgba(0, 0, 0, 0.54);
        }

        ul.labeled_list, ul.statement_list {
            list-style: none;
            padding: 0;
            margin: 0;

        }

        ul.labeled_list li, ul.statement_list li {
            margin-bottom: .2em;
            display: flex;
            gap: 0;
            flex-direction: row;
        }

        ul.statement_list {
            margin-bottom: .2em;
            font-size: small;
        }

        .labeled_list .list_key {
            color: rgb(102, 102, 102);
            padding: .1em .4em;
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
            border: 1px solid rgb(102, 102, 102);
            margin: 0;
            flex: 1;
            min-width: 150px;
            max-width: 30vw;
        }

        .labeled_list .list_label {
            background-color: rgb(102, 102, 102);
            color: white;
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
            padding: .1em .4em;
            border: 1px solid rgb(102, 102, 102);
            margin: 0;
            flex: 1;
            min-width: 150px;
            max-width: 30vw;
        }

        .console {
            background-color: rgb(245, 245, 245);
            padding: 1em;
            border-radius: 4px;
            border: 1px solid rgb(221, 221, 221);
            /*max-height: 50vh;*/
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1em;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            color: rgb(34, 34, 34);
            word-wrap: break-word;
            white-space: pre-wrap;
            text-align: left;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
        }

        .console > div {
            margin-bottom: .5em;
        }

        .db-results > table {
            margin: 1em;
            font-size: small;
        }

        .button_rpc {
            margin-right: .5em;
        }

        .button-error {
            color: rgb(202, 60, 60);
            cursor: pointer;
        }

        .button-error:hover {
            color: rgb(226, 91, 91);
        }

        .main-toolbar {
            margin-bottom: 0;
        }

        .error {
            color: rgb(202, 60, 60);
        }

        .notification {
            color: red;
        }

        .update {
            color: green;
        }

        .pong {
            color: blue;
        }

        .loading {
            color: rgb(102, 102, 102);
            font-size: .87em;
            padding: .5em;
            display: none;
            cursor: wait;
            margin-top: .5em;
        }

        .loading:has(.loading_div) {
            display: block;
        }

        .loading > div {
            display: inline-block;
            vertical-align: middle;
            margin-left: .5em;
        }

        .loading.active:before {
            content: '';
            display: inline-block;
            vertical-align: middle;
            width: .87em;
            height: .87em;
            border: 2px solid rgb(102, 102, 102);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        .statements .statement {
            display: block;
            margin-bottom: .4em;
            margin-left: 1.3em;
        }

        .statement_info {
            margin: 1em auto;
        }

        .statement_info .statement_variant {
            margin: 1em;
        }

        .statement_info .statement_variant .metadata, .statement_info .statement_variant .params {
            margin: .5em;
        }

        .statement_info .statement_variant .params .statement_param, .statement_info .statement_variant .metadata .statement_list {
            min-width: calc(300px + .5em);
            max-width: calc(600px + .5em);
        }

        .statement_list .list_key {
            color: rgb(102, 102, 102);
            padding: .1em .4em;
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
            border: 1px solid rgb(102, 102, 102);
            margin: 0;
            flex: 1;
            min-width: 150px;
            max-width: 300px;
        }

        .statement_list .list_label {
            background-color: rgb(102, 102, 102);
            color: white;
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
            padding: .1em .4em;
            border: 1px solid rgb(102, 102, 102);
            margin: 0;
            flex: 1;
            min-width: 150px;
            max-width: 300px;
        }

        span.param_name {
            display: block;
            text-align: right;
        }

        .required .param_name {
            color: rgb(202, 60, 60);
        }

        .required .param_name:before {
            content: '* ';
        }
        .disabled-link {
            pointer-events: none; /* Prevents clicks/taps */
            cursor: default;     /* Changes the cursor from a hand to the default arrow */
            color: #dadada;         /* Optional: styles the link to look disabled */
            text-decoration: none; /* Optional: removes the underline */
        }

    </style>
    <script type="module">
        console.log('Script cargado');
        import VecturaPubSub from './js/VecturaPubSub.js';

        window.pubsub = new VecturaPubSub(
            'ws://127.0.0.1:9801',
            {
                maxFileSize: 100 * 1024 * 1024,
                maxReconnectAttempts: 15,
                verbose: true
            }
        );
        const channels = [
            'global.notifications',
            'global.updates'
        ];

        window.pubsub.connect();
        let buttonsInitialized = false;
        let menuReady = false;
        let li4StyleDisplay, li4, li5;
        const objectToList = (obj, cls = 'labeled_list') => {
            const ul = document.createElement('ul'),
                canBeTimestamp = function (key) {
                    return key.includes('timestamp') || key.includes('time') || key.includes('date') || key.includes('datetime') || key.includes('created_at')
                },
                validTimeStamp = function (timestamp) {
                    if (typeof timestamp !== 'number' || !Number.isFinite(timestamp)) {
                        return false;
                    }
                    // Assume it might be in milliseconds, as Date constructor expects milliseconds
                    const date = new Date(timestamp);
                    // Check if the date object is valid and the timestamp value matches
                    // (accounting for potential conversion from seconds to milliseconds if needed)
                    return date.getTime() === timestamp || date.getTime() === timestamp * 1000;
                }
            ul.classList.add(cls);
            for (const key in obj) {
                // To avoid inherited properties, check with hasOwnProperty
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    if (key.startsWith('_')) continue;
                    const element = document.createElement('li');
                    if (typeof obj[key] === 'object') {
                        if (obj[key] !== null && Object.keys(obj[key]).length > 0 && !Array.isArray(obj[key])) {
                            const childList = objectToList(obj[key]);
                            childList.classList.add('list_child');
                            element.append(childList)
                        } else {
                            continue;
                        }
                    } else {
                        console.log(obj[key])
                        if (key.replace(/ /g, '').length === 0 || !obj[key] || (typeof obj[key] === 'string' && obj[key].replace(/ /g, '').length === 0)) continue;
                        const keyEl = document.createElement('span');
                        keyEl.classList.add('list_key');
                        keyEl.innerText = key;
                        element.append(keyEl);

                        const labelEl = document.createElement('span');
                        labelEl.classList.add('list_label');
                        labelEl.innerText = obj[key];
                        if (canBeTimestamp(key) && validTimeStamp(obj[key] * 1000)) {
                            labelEl.innerText = ` ${new Date(obj[key] * 1000).toLocaleString()}`
                        }
                        element.append(labelEl);
                    }
                    ul.append(element)
                }
            }
            return ul;
        }
        const processResults = {
                'global.notifications': (data) => {
                    console.log('Notificaciones:', data);
                    const notification = document.createElement('div');
                    notification.classList.add('notification');
                    notification.innerText = 'üîîÔ∏è ' + (data.message || data.text || data.data);
                    document.querySelector('article').insertAdjacentElement("beforeend", notification).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                },
                'global.updates': (data) => {
                    console.log('Actualizaciones:', data);
                    const update = document.createElement('div');
                    update.classList.add('update');
                    update.innerText = '‚ö°Ô∏è ' + data.message;
                    document.querySelector('article').insertAdjacentElement("beforeend", update).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                },
                'ping': (data) => {
                    console.log('Ping:', data);
                    const response = new Date().getTime() - data.timestamp * 1000 + 'ms';
                    const pong = document.createElement('div');
                    pong.classList.add('pong');
                    pong.innerText = 'üèì Pong: ' + response + ''
                    document.querySelector('article').insertAdjacentElement("beforeend", pong).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                },
                'server.stats': (data) => {
                    console.log('üåé Server stats:', data);
                    const div = document.createElement('div'),
                        stats = objectToList(data)
                    div.classList.add('stats');
                    div.innerText = 'üåé Stats: '
                    div.append(stats)
                    document.querySelector('article').insertAdjacentElement("beforeend", div).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                },
                'math.calculate': (data) => {
                    console.log('Calculation result:', data);
                    const div = document.createElement('div'),
                        result = objectToList(data)
                    div.classList.add('calculation');
                    div.innerText = 'üßÆ Calculation result: '
                    div.append(result)
                    document.querySelector('article').insertAdjacentElement("beforeend", div).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                },
                'worker.info': (data) => {
                    console.log('Worker info:', data);
                    const div = document.createElement('div'),
                        info = objectToList(data)
                    div.classList.add('worker_info');
                    div.innerText = 'üë∑üèΩ‚Äç‚ôÇÔ∏è Worker info: '
                    div.append(info)
                    document.querySelector('article').insertAdjacentElement("beforeend", div).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                },
                'channels.list': (data) => {
                    console.log('Channel list:', data);
                    const div = document.createElement('div');
                    div.classList.add('channel_list');
                    div.innerText = `üì∫ ${data.total} Channels on worker #${data.worker_id}: `
                    data.channels.forEach((channel, index) => {
                        const channelDiv = document.createElement('div');
                        channelDiv.classList.add('channel');
                        channelDiv.innerText = `Channel #${index}`;
                        channelDiv.append(objectToList(channel))
                        div.append(channelDiv)
                    });
                    document.querySelector('article').insertAdjacentElement("beforeend", div).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                },
                'client.info': (data) => {
                    console.log('Client info:', data);
                    const div = document.createElement('div'),
                        info = objectToList(data)
                    div.classList.add('client_info');
                    div.innerText = 'üìÉ Client info: '
                    div.append(info)
                    document.querySelector('article').insertAdjacentElement("beforeend", div).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                },
                'default': (data) => {
                    console.log('Default:', data);
                    const div = document.createElement('div');
                    div.classList.add('default');
                    div.innerText = 'üóíÔ∏è ' + JSON.stringify(data, null, 2) //JSON.stringify(myObject, null, 2);
                    document.querySelector('article').insertAdjacentElement("beforeend", div).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                },
                'error': (error) => {
                    console.error('Error:', error);
                    const div = document.createElement('div');
                    div.classList.add('error');
                    div.innerText = '‚ùå ' + (error.message || error.text || error.message || error.data)
                    document.querySelector('article').insertAdjacentElement("beforeend", div).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });

                },
                'message': (event) => {
                    console.debug('message:', event);
                    const div = document.createElement('div');
                    div.classList.add('text-message');
                    div.innerText = 'üì® ' + event.message
                    document.querySelector('article').insertAdjacentElement("beforeend", div).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                },
                'db.hub': (data) => {
                    console.log('db.hub:', data);
                    if (!data) {
                        processResults['error']({message: 'No data received'});
                        return;
                    }
                    //data = JSON.parse(data);
                    console.log('db.hub parsed!: ', data);
                    const formatResult = (data) => {
                        if (!data) return '';
                        if (data instanceof Date) {
                            data = data.toLocaleString();
                        }
                        if (typeof data === 'object') {
                            if (Object.keys(data).includes('date')) {
                                if (Object.keys(data).includes('timezone') && data['timezone'] === 'UTC') {
                                    data = new Date(Date.UTC(...data['date'].split(/\D+/))).toLocaleString();
                                } else {
                                    data = new Date(data['date']).toLocaleString();
                                }
                            }
                        }
                        if (Array.isArray(data)) {
                            data.forEach(item => formatResult(item));
                        }
                        if (typeof data === 'number') {
                            data = data.toLocaleString();
                        }
                        return data
                    }
                    if (data.status !== 200) {
                        processResults['error'](data);
                        return;
                    }
                    const div = document.createElement('div')
                    div.classList.add('db-results')
                    let stats = `${data.total} registros`
                    if ('_metadata' in data) {
                        if ('execution_time_ms' in data._metadata) {
                            stats += ` | ${data._metadata.execution_time_ms}ms`
                        }
                        if ('worker_id' in data._metadata) {
                            stats += ` | Worker #${data._metadata.worker_id}`
                        }
                    }

                    const title = `üóÉÔ∏è Resultados de la consulta (${stats})`
                    div.innerHTML = `<div class="pure-menu-heading">${title}</div>`
                    if (data.total > 0) {
                        const table = document.createElement('table'),
                            results = data.data,
                            fields = Object.keys(results[0]);
                        table.classList.add('pure-table');
                        table.innerHTML = `<thead><tr>${fields.map(field => `<th>${field}</th>`).join('')}</tr></thead><tbody>${results.map(row => `<tr>${fields.map(field => `<td>${formatResult(row[field])}</td>`).join('')}</tr>`).join('')}</tbody>`;
                        div.append(table);
                    }


                    document.querySelector('article').insertAdjacentElement("beforeend", div).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                },
                'db.processor': (data) => {
                    return processResults['db.hub'](data);
                },
                'db.statement.list': function (data) {
                    console.debug('statements:', data);
                    const div = document.createElement('div');
                    div.classList.add('statements');
                    div.innerText = 'üõçÔ∏è Available statements descriptors:'
                    for (const statement of Object.entries(data)) {
                        if (statement[0].startsWith('_')) continue;
                        const statementDiv = document.createElement('button');
                        statementDiv.classList.add('pure-button-primary', 'pure-button', 'statement');
                        statementDiv.innerText = `üîÖ ${statement[1]}`;
                        statementDiv.href = '#';
                        statementDiv.title = `Get statement info`;
                        statementDiv.addEventListener('click', () => {
                            console.log('Get statement info:', statement[1]);
                            rpcProcessors['default']('db.statement.info', {cfg: statement[1]});
                        })
                        div.append(statementDiv)
                    }
                    document.querySelector('article').insertAdjacentElement("beforeend", div).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });


                },
                'db.statement.info': function (data) {
                    console.debug('statement info:', data);
                    const div = document.createElement('div');
                    div.classList.add('statement_info');
                    div.innerText = `üìü Statement ${data.cfg}, ${data.variants.length} variants available:`
                    const removeIfmatch = function (obj, prefixes = []) {
                        for (const key in obj) {
                            prefixes.forEach(prefix => {
                                if (Object.prototype.hasOwnProperty.call(obj, key) && key.startsWith(prefix)) {
                                    delete obj[key];
                                }
                            })
                        }
                        return obj; // Return the modified object
                    }
                    const processParam = function (param) {
                        const div = document.createElement('div'),
                            span = document.createElement('span');
                        div.classList.add('statement_param');
                        span.innerHTML = `Param name: <b>${param.name || param.placeholder.replace(':', '')}</b> | <i>${param.type}</i>`;
                        span.classList.add('param_name');
                        div.append(span);
                        if (param.required) div.classList.add('required');
                        div.append(objectToList(removeIfmatch(param, ['paramName', 'name', 'quote']), 'statement_list'))
                        return div;
                    }
                    const prepareParams = function (params) {
                        const out = {}

                        if (params.required.length > 0) {
                            params.required.forEach((param) => {
                                const name = param.name || param.placeholder.replace(':', '');

                                out[name] = prompt(`Enter param ${name} (${param.type})*:`, param.defaultValue)
                                if (!out[name]) {
                                    alert(`Param ${name} is required`);
                                    throw new Error(`Param ${name} is required`);
                                }
                            })
                        }

                        if (params.optional.length > 0) {
                            params.optional.forEach((param) => {
                                const name = param.name || param.placeholder.replace(':', '');
                                out[name] = prompt(`Enter param ${name} (${param.type}, optional):`, param.defaultValue)
                                console.log('Add param? ', name, out[name])
                                if (!out[name]) {
                                    console.log('Param not added, empty:', name)
                                    delete out[name];
                                }
                            })
                        }
                        console.log('Prepared params:', out)
                        return out;
                    }
                    data.variants.forEach((variant, idx) => {
                        const currentVariant = variant.metadata[variant.variantMember];
                        const variantDiv = document.createElement('div');
                        variantDiv.classList.add('statement_variant');
                        variantDiv.innerText = `Variant #${idx + 1} - ${variant.variantMember}[${currentVariant}] (type: ${variant.type}):`;
                        const sql = document.createElement('button');
                        sql.classList.add('pure-button-primary', 'pure-button', 'sql');
                        sql.innerText = `SQL statement`;
                        sql.addEventListener('click', () => {
                            //db.get.statement.for
                            const cfg = {
                                forceReload: false,
                                cfg: data.cfg,
                                params: prepareParams(variant.params)
                            }
                            cfg[variant.variantMember] = currentVariant === '*' ? 1 : currentVariant;
                            console.log('Get SQL statement for variant:', cfg)
                            rpcProcessors['default']('db.get.statement.for', cfg);
                        })
                        variantDiv.append(sql)
                        const execute = document.createElement('button');
                        execute.classList.add('pure-button-primary', 'pure-button', 'execute');
                        execute.innerText = `Execute`;
                        execute.addEventListener('click', () => {
                            const cfg = {
                                forceReload: false,
                                cfg: data.cfg,
                                params: prepareParams(variant.params)
                            }

                            cfg[variant.variantMember] = currentVariant === '*' ? 1 : currentVariant;
                            rpcProcessors['db'](cfg, 'processor');
                        })
                        variantDiv.append(execute)
                        const metadata = document.createElement('div')
                        metadata.classList.add('metadata');
                        metadata.innerText = `Metadata:`
                        variantDiv.append(metadata)
                        metadata.append(objectToList(variant.metadata, 'statement_list'))
                        const params = document.createElement('div')
                        if (variant.params.required.length > 0 || variant.params.optional.length > 0) {
                            params.classList.add('params');
                            if (variant.params.required.length > 0) {
                                params.append(`Params required:`)
                                variant.params.required.forEach(param => params.append(processParam(param)))
                            }
                            if (variant.params.optional.length > 0) {
                                params.append(`Params optionals:`)
                                variant.params.optional.forEach(param => params.append(processParam(param)))
                            }
                        } else {
                            params.append(`No params`)
                        }
                        variantDiv.append(params)

                        div.append(variantDiv)
                    })

                    document.querySelector('article').insertAdjacentElement("beforeend", div).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                },
                /*
        'statement' => $builder->getStatement(),
        'prettyStatement' => $builder->getPrettyStatement(),
        'bindings' => $builder->getBindings(),
        'requiredParams' => $builder->getRequiredParams() ?? [],
        'optionalParams' => $builder->getOptionalParams() ?? [],
        'sentParams' => $request->params ?? [],
        'descriptor' => $descriptor->toArray(),
        'connection' => $builder->getMetadataValue('connection'),
        'operation' => $builder->getMetadataValue('operation')
                 */
                'db.get.statement.for': function (data) {
                    console.log('Statement for:', data);
                    const div = document.createElement('div')
                    div.classList.add('sql-statement')
                    div.innerText = data.cfg
                    const sql = document.createElement('div');
                    sql.classList.add('sql')
                    sql.innerText = data.prettyStatement
                    div.append(sql)
                    if (data.bindings && Object.keys(data.bindings).length > 0) {
                        const bindings = document.createElement('div');
                        bindings.classList.add('bindings')
                        bindings.innerText = `Bindings:`
                        bindings.append(objectToList(data.bindings, 'statement_list'))
                        div.append(bindings)
                    }
                    document.querySelector('article').insertAdjacentElement("beforeend", div).scrollIntoView({
                        behavior: 'smooth', // Optional: for smooth scrolling animation
                        block: 'end'
                    });
                }
            },
            resolveIcon = (method, needAuth = false) => {
                if (needAuth) return 'üïµ';
                const icons = {
                    'global.notifications': 'üîî',
                    'global.updates': '‚ö°Ô∏è',
                    'ping': 'üèì',
                    'server.stats': 'üåé',
                    'math.calculate': 'üßÆ',
                    'worker.info': 'üë∑üèΩ‚Äç‚ôÇÔ∏è',
                    'channels.list': 'üì∫',
                    'client.info': 'üìÉ',
                    'db.hub': 'üéõÔ∏è',
                    'db.processor': 'üß´',
                    'db.statement.list': 'ü™ú'
                }
                return icons[method] || 'üóíÔ∏è'
            },
            rpcProcessors = {
                'db': function (params, method) {
                    //['forceReload' =>$force, 'cfg' => 'Hr/deposito/Deposito', 'allowed' => 2, 'params' => ['warehouse_id' => 397]]
                    pubsub.rpc(`db.${method}`, params).then(result => {
                        console.log(`Resultado db.${method}:`, result);
                        const processor = processResults[`db.${method}`] || processResults['default'];
                        processor(result);
                    }).catch(error => {
                        console.error('Error:', error);
                        processResults['error'](error);
                    })
                },
                'db.hub': function (data) {
                    const params = {
                            forceReload: false,
                            cfg: 'Hr/deposito/Deposito',
                            allowed: 2,
                            params: {
                                warehouse_id: 397
                            }
                        },
                        paramsParte = {
                            forceReload: true,
                            cfg: 'Pt/despacho/Expedicion',
                            allowed: 2,
                            params: {
                                subinventarios: '397'
                            }
                        },
                        paramExec = {
                            forceReload: true,
                            cfg: 'Ora/SyncOrganizations',
                            allowed: 2,
                            params: {}
                        },
                        paramsBtCamion = {
                            forceReload: false,
                            cfg: 'Bt/transporte/Camion',
                            allowed: 2,
                        }
                    rpcProcessors['db'](data || paramsBtCamion, 'hub');
                },
                'db.processor': function (data) {

                    const params = {
                            forceReload: false,
                            cfg: 'Hr/deposito/Deposito',
                            allowed: 2,
                            params: {
                                warehouse_id: 397
                            }
                        },
                        paramsParte = {
                            forceReload: true,
                            cfg: 'Pt/despacho/Expedicion',
                            allowed: 2,
                            params: {
                                subinventarios: '397'
                            }
                        },
                        paramExec = {
                            forceReload: true,
                            cfg: 'Ora/SyncOrganizations',
                            allowed: 2,
                            params: {}
                        },
                        paramsBtCamion = {
                            forceReload: false,
                            cfg: 'Bt/transporte/Camion',
                            allowed: 2,
                        }
                    rpcProcessors['db'](data || paramsBtCamion, 'processor');
                },
                'db.statement.info': function (data) {
                    processResults['message']({message: 'Statement info: Execute from the results generated by "db.statement.list"'});
                },
                'math.calculate': function (data) {

                },
                'default': function (method, data) {
                    pubsub.rpc(method, data).then(result => {
                        console.log(`Resultado ${method}:`, result);
                        const processor = processResults[method] || processResults['default'];
                        processor(result);
                    }).catch(error => {
                        console.error('Error:', error);
                        processResults['error'](error);
                    });
                }
            }

        pubsub.on(pubsub.EVENT_TYPE_SUBSCRIBED, (channel) => {
            processResults['message']?.({message: 'Subscribed to channel: ' + channel.detail});
            const li = document.createElement('li'),
                button = document.createElement('a'),
                icon = resolveIcon(channel.detail),
                toolbar = document.querySelector('.msg_publisher'),
                toolbar_button = document.querySelector('a:has(+ ul.msg_publisher)');
            li.classList.add('pure-menu-item');
            button.classList.add('publisher_', 'publisher_' + channel.detail.replaceAll('.', '_'), 'pure-menu-link');
            button.href = '#';
            button.innerText = `${icon} ${channel.detail}`;
            button.title = `Publish to ${channel.detail}`;
            button.addEventListener('click', () => {
                const message = prompt('Message:');
                if (!message) return;
                pubsub.publish(channel.detail, {message: message})
            });
            li.appendChild(button);
            toolbar.appendChild(li);
            toolbar_button.classList.remove('disabled-link');

        });
        pubsub.on(pubsub.EVENT_TYPE_UNSUBSCRIBED, (channel) => {
            processResults['message']?.({message: 'Unsubscribed from channel: ' + channel.detail});
            const li = document.querySelector('.publisher_' + channel.detail.replaceAll('.', '_'));
            console.log('Remove subscription: ', channel, li);
            if (li) li.remove();
        })
        // Suscribirse a eventos
        pubsub.on(pubsub.EVENT_TYPE_MESSAGE, (event) => {
            console.log('Mensaje recibido:', event);
            const channel = event.data.channel;
            processResults[channel]?.(event.data.data);
        });
        pubsub.on(pubsub.EVENT_TYPE_READY, async () => {
            const article = document.querySelector('article'),
                menu = document.querySelector('.pure-menu-list'),
                toolbar = document.querySelector('.rpc_actions'),
            toolbar_button = document.querySelector('a:has(+ ul.rpc_actions)');
            console.log('Conectado a servidor');
            const typeNotif = menuReady ? 'global.notifications' : 'global.updates'
            processResults[typeNotif]({
                message: menuReady ? 'Reconexi√≥n exitosa' : 'Conectado a servidor'
            })
            //Channel subscription
            channels.forEach(channel => window.pubsub.subscribe(channel));
            if (!menuReady) {
                menuReady = true;
                const li1 = document.createElement('li'),
                    button = document.createElement('a');
                li1.classList.add('pure-menu-item');
                button.classList.add('button-error', 'pure-menu-link');
                button.href = '#';
                button.innerText = 'Clean results';
                button.addEventListener('click', () => {
                    article.innerHTML = '';
                    processResults['message']({message: 'Results cleaned ' + new Date().toLocaleString()});
                });
                li1.appendChild(button);


                li4 = document.createElement('li');
                const disconnect = document.createElement('a');
                li4.classList.add('pure-menu-item');
                disconnect.classList.add('disconnect', 'pure-menu-link');
                disconnect.href = '#';
                disconnect.innerText = '‚úÖ';
                disconnect.title = 'Conectado - Click para desconectar del servidor';
                disconnect.addEventListener('click', () => {
                    pubsub.disconnect();
                })
                li4.appendChild(disconnect);

                li5 = document.createElement('li');
                const connect = document.createElement('a');
                li5.classList.add('pure-menu-item');
                connect.classList.add('connect', 'pure-menu-link');
                connect.href = '#';
                connect.innerText = 'üö´';
                connect.title = 'Desconectado - Click para conectarse al servidor';
                connect.addEventListener('click', () => {
                    pubsub.connect();
                })
                li5.appendChild(connect);

                menu.insertAdjacentElement('beforeend', li1);
                menu.insertAdjacentElement('beforeend', li5);
                menu.insertAdjacentElement('beforeend', li4);
                li4StyleDisplay = getComputedStyle(li4).display;

            }
            li4.style.display = li4StyleDisplay;
            li5.style.display = 'none';
            //article.insertAdjacentElement("beforebegin", document.createElement('br'));
            try {
                // Listar m√©todos disponibles
                /** @type {Object[]} */
                const methods = await pubsub.listRpcMethods();
                console.log('M√©todos RPC disponibles:', methods);
                if (methods) {
                    if (buttonsInitialized) {
                        const elements = document.querySelectorAll(`.button_rpc`);
                        elements.forEach(element => {
                            element.remove();
                        });
                        toolbar_button.classList.add('disabled-link');
                        buttonsInitialized = false;
                    }
                    methods.forEach((method, index) => {
                        const li = document.createElement('li'),
                            button = document.createElement('a'),
                            icon = resolveIcon(method.name, method.requires_auth);
                        li.classList.add('pure-menu-item');
                        button.classList.add('button_rpc', 'button_rpc_' + index % 3, 'pure-menu-link');
                        button.href = '#';
                        button.innerText = `${icon} ${method.name}`;
                        button.title = method.description;

                        if (method.name in rpcProcessors) {
                            button.addEventListener('click', () => {
                                rpcProcessors[method.name]();
                            });
                        } else {
                            button.addEventListener('click', () => {
                                rpcProcessors['default'](method.name, {});
                            })
                        }
                        li.appendChild(button);
                        toolbar.appendChild(li);
                    })
                    if(methods.length > 0) toolbar_button.classList.remove('disabled-link');
                    buttonsInitialized = true;
                }

            } catch (error) {
                console.error('RPC error:', error);
            }
        });
        pubsub.on(pubsub.EVENT_TYPE_RPC_START_EXEC, (event) => {
            console.log(`RPC ${event.detail.method} start exec: `, event.detail.id);
            const rpcInfo = document.querySelector('.loading'),
                loading = document.createElement('div');
            rpcInfo.classList.add('active');
            loading.classList.add('loading_div', `loading_rpc_${event.detail.id}`);
            loading.innerHTML = `Loading ${event.detail.method}...`;
            rpcInfo.appendChild(loading);
        })
        pubsub.on(pubsub.EVENT_TYPE_RPC_COMPLETED, (event) => {
            console.log(`RPC ${event.detail.method} completed: `, event.detail.id);
            const rpcInfo = document.querySelector('.loading'),
                loading = document.querySelector(`.loading_rpc_${event.detail.id}`);
            rpcInfo.classList.remove('active');
            loading.innerHTML = `Call to ${event.detail.method} completed`
            setTimeout(() => loading.remove(), 3000)
        })
        pubsub.on(pubsub.EVENT_TYPE_RPC_ABORTED, (event) => {
            console.log(`RPC ${event.detail.method} aborted: `, event.detail.id);
            const rpcInfo = document.querySelector('.loading'),
                loading = document.querySelector(`.loading_rpc_${event.detail.id}`);
            rpcInfo.classList.remove('active');
            loading.innerHTML = `Call to ${event.detail.method} aborted by error`
            setTimeout(() => loading.remove(), 2000)
        });
        pubsub.on(pubsub.EVENT_TYPE_RECONNECTING, (event) => {
            console.log('Reconectando...');
            processResults['message']({message: event.detail || 'Reconectando al servidor'});
        })
        pubsub.on(pubsub.EVENT_TYPE_ERROR, (event) => {
            console.error('Error:', event);
            processResults['error'](event);
            if (!pubsub.isReady()) {
                const ulNotifications = document.querySelector('.msg_publisher');
                ulNotifications.innerHTML = '';
                li5.style.display = li4StyleDisplay;
                li4.style.display = 'none';
            }
        })
        pubsub.on(pubsub.EVENT_TYPE_CLOSE, () => {
            const ulNotifications = document.querySelector('.msg_publisher');
            ulNotifications.innerHTML = '';
            console.log('Desconectado del servidor');
            processResults['error']({message: 'Desconectado del servidor'});
            li5.style.display = li4StyleDisplay;
            li4.style.display = 'none';
        })
    </script>
</head>
<body>
<div class="pure-menu pure-menu-horizontal main-toolbar flex-menu">
    <ul class="pure-menu-list">
        <li class="pure-menu-item">
            <div class="title-v">
                <h3 class="title">Test Websocket SIG server</h3>
                <h5 class="subtitle">This is a test page for Vectura Pub/Sub Client.</h5>
            </div>
        </li>
        <li class="pure-menu-item" style="flex: 1"></li>
        <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
            <a href="#" class="pure-menu-link disabled-link">Send notification</a>
            <ul class="pure-menu-children msg_publisher">
            </ul>
        </li>
        <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
            <a href="#" class="pure-menu-link disabled-link">RPC actions</a>
            <ul class="pure-menu-children rpc_actions">
            </ul>
        </li>
    </ul>
</div>
<div class="pure-menu pure-menu-horizontal loading"></div>
<article class="console">
</article>
</body>
</html>